---
title: "HSC_PROJECT_REPORT"
author: "Shuhei Iimura"
date: "2019年5月22日"
output: 
  html_document:
    toc: true
    toc:_depth: 4
    toc_float: true
    df_print: "paged"
    theme: journal
---
 
```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.height = 12, fig.width = 12, warning = FALSE, cache = TRUE)
#セットアップチャンクの設定はこの通り #エラー警告は非表示にした #キャッシュ利用に設定
```

#★レポートの説明★
```
このレポートは、原稿"Highly Sensitive Adolescent Benefits in Positive School Transitions"の結果をまとめたものである。結果の構成は以下のとおり。
```  
  * （1）前処理
  * （2）記述統計量と可視化
  * （3）因子分析
  * （4）精神的健康の潜在変化得点算出
  * （5）HSCのクラスタ抽出
  * （6）環境変化→健康変化の単回帰分析
  * （7）HSCグループごとの分位点回帰（感度分析として）
  * （8）階層的重回帰分析

#（1）前処理

##1-1. ローデータの読み込みと2時点データ結合
```{r handling, include = TRUE}

#前処理に必要なパッケージ読み込み
library(tidyverse)

#各時点のローデータ読み込み
DataSourceT1 <- read_csv("Time1_rawdata.csv", na = c(".", "")) #Time1のローデータ読み込み
DataSourceT2 <- read_csv("Time2_rawdata.csv", na = c(".", "")) #Time2のローデータ読み込み
head(DataSourceT1) #先頭6行確認
head(DataSourceT2) #先頭6行確認

#各時点のローデータの結合
DataSource <- full_join(DataSourceT1, DataSourceT2, by = "ID", na = c(".", ""))
  #full_join(データ1, データ2, by = 共通のキー変数名)
head(DataSource) #先頭6行確認
tail(DataSource) #末尾6行確認
names(DataSource) #変数名確認
```

##1-2. 合計得点の算出と列追加
```{r createvariables, include = TRUE}
#合計得点の算出と列の追加：インプットデータ作成（# 参考として徳岡さんの資料参考http://rpubs.com/t_macya/333965）
InputData <- DataSource %>% 
  dplyr::mutate(bis1_T2 = 5 - bis1r_T2) %>% #bis1r_T2を逆転しbis1_T2という列を追加
  dplyr::mutate(bis6_T2 = 5 - bis6r_T2) %>% #bis1r_T2を逆転しbis1_T2という列を追加

#HSCSの易興奮性得点算出（T1とT2）
  dplyr::mutate(eoe_mean_T1 = (hsc8_T1 + hsc6_T1 + hsc4_T1 + hsc9_T1+ hsc12_T1)/5, na.rm = TRUE) %>% #T1
  dplyr::mutate(eoe_mean_T2 = (hsc8_T2 + hsc6_T2 + hsc4_T2 + hsc9_T2+ hsc12_T2)/5, na.rm = TRUE) %>% #T2
  
#HSCSの低閾値得点算出（T1とT2）
  dplyr::mutate(lst_mean_T1 = (hsc2_T1 + hsc11_T1)/2, na.rm = TRUE) %>% #T1
  dplyr::mutate(lst_mean_T2 = (hsc2_T2 + hsc11_T2)/2, na.rm = TRUE) %>% #T2
  
#HSCSの美的感受性得点算出（T1とT2）
  dplyr::mutate(aes_mean_T1 = (hsc5_T1 + hsc10_T1 + hsc1_T1 + hsc3_T1)/4, na.rm = TRUE) %>% #T1
  dplyr::mutate(aes_mean_T2 = (hsc5_T2 + hsc10_T2 + hsc1_T2 + hsc3_T2)/4, na.rm = TRUE) %>% #T2
  
#HSCSの合計平均得点算出（T1とT2）
  dplyr::mutate(hsc_mean_T1 = (eoe_mean_T1 + lst_mean_T1 + aes_mean_T1)/3, na.rm = TRUE) %>% #T1
  dplyr::mutate(hsc_mean_T2 = (eoe_mean_T2 + lst_mean_T2 + aes_mean_T2)/3, na.rm = TRUE) %>% #T2

#精神的健康の合計得点算出（T1とT2）
  dplyr::mutate(health_mean_T1 = (health1_T1 + health2_T1 + health2_T1 + health4_T1 + health5_T1)/5, na.rm = TRUE) %>% #T1
  dplyr::mutate(health_mean_T2 = (health1_T2 + health2_T2 + health2_T2 + health4_T2 + health5_T2)/5, na.rm = TRUE) %>% #T2

#PANASのpositive得点算出（T1）
  dplyr::mutate(positive_mean_T1 = (panas2_T1 + panas4_T1 + panas6_T1 + panas8_T1 + panas10_T1 + panas12_T1 + panas14_T1 + panas16_T1)/8, na.rm = TRUE) %>% #T1
  
#PANASのnegative得点算出（T1）
  dplyr::mutate(negative_mean_T1 = (panas1_T1 + panas3_T1 + panas5_T1 + panas7_T1 + panas9_T1 + panas11_T1 + panas13_T1 + panas15_T1)/8, na.rm = TRUE) %>% #T1
  
#学校環境変化尺度の合計得点算出（T2）
  dplyr::mutate(environment_mean_T2 = (environment1_T2 + environment2_T2 + environment3_T2 + environment4_T2 + environment5_T2 + environment6_T2 + environment7_T2 + environment8_T2 + environment9_T2 + environment10_T2 + environment11_T2)/11, na.rm = TRUE) %>% #T2
  
#BISの得点算出（T2）
  dplyr::mutate(bis_mean_T2 = (bis1_T2 + bis2_T2 + bis3_T2 + bis4_T2 + bis5_T2 + bis6_T2 + bis7_T2)/7, na.rm = TRUE) %>% #T2
  
#BASの得点算出（T2）
  dplyr::mutate(bas_mean_T2 = (bas1_T2 + bas2_T2 + bas3_T2 + bas4_T2 + bas5_T2 + bas6_T2 + bas7_T2 + bas8_T2 + bas9_T2 + bas10_T2 + bas11_T2 + bas12_T2 + bas13_T2)/7, na.rm = TRUE) #T2
  
#インプットデータの確認
head(InputData) #先頭6行確認
names(InputData) #変数名確認
```

#（2）記述統計量と可視化

楽に可視化したいなら以下のコードでGUI上のPlotlyタブをいじればOK！
  * library(ggplotgui)
  * ggplot_shiny(dataset = InputData)

##2-1. 全変数の度数分布

###2-1-1. 性別の度数分布
```{r count_gender, include = TRUE}
#child_gender_T1の度数分布
child_gender_count_T1 <- dplyr::count(InputData, child_gender_T1)
knitr::kable(child_gender_count_T1) #テーブル化
ggplot(data = InputData, mapping = aes(x = child_gender_T1, fill = factor(child_gender_T1))) + geom_bar() #視覚化

#child_gender_T2の度数分布
child_gender_count_T2 <- dplyr::count(InputData, child_gender_T2)
knitr::kable(child_gender_count_T2) #テーブル化
ggplot(data = InputData, mapping = aes(x = child_gender_T2, fill = factor(child_gender_T2))) + geom_bar() #視覚化
```

###2-1-2. HSCSの度数分布
```{r count_hscs, include = TRUE}
#hsc1_T1の度数分布
hsc1_T1_count <- dplyr::count(InputData, hsc1_T1)
knitr::kable(hsc1_T1_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = hsc1_T1, fill = factor(hsc1_T1))) + geom_histogram(binwidth = 1) #視覚化

#hsc2_T1の度数分布
hsc2_T1_count <- dplyr::count(InputData, hsc2_T1)
knitr::kable(hsc2_T1_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = hsc2_T1, fill = factor(hsc2_T1))) + geom_histogram(binwidth = 1) #視覚化

#hsc3_T1の度数分布
hsc3_T1_count <- dplyr::count(InputData, hsc3_T1)
knitr::kable(hsc3_T1_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = hsc3_T1, fill = factor(hsc3_T1))) + geom_histogram(binwidth = 1) #視覚化

#hsc4_T1の度数分布
hsc4_T1_count <- dplyr::count(InputData, hsc4_T1)
knitr::kable(hsc4_T1_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = hsc4_T1, fill = factor(hsc4_T1))) + geom_histogram(binwidth = 1) #視覚化

#hsc5_T1の度数分布
hsc5_T1_count <- dplyr::count(InputData, hsc5_T1)
knitr::kable(hsc5_T1_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = hsc5_T1, fill = factor(hsc5_T1))) + geom_histogram(binwidth = 1) #視覚化

#hsc6_T1の度数分布
hsc6_T1_count <- dplyr::count(InputData, hsc6_T1)
knitr::kable(hsc6_T1_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = hsc6_T1, fill = factor(hsc6_T1))) + geom_histogram(binwidth = 1) #視覚化

#hsc7_T1の度数分布
hsc7_T1_count <- dplyr::count(InputData, hsc7_T1)
knitr::kable(hsc7_T1_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = hsc7_T1, fill = factor(hsc7_T1))) + geom_histogram(binwidth = 1) #視覚化

#hsc8_T1の度数分布
hsc8_T1_count <- dplyr::count(InputData, hsc8_T1)
knitr::kable(hsc8_T1_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = hsc8_T1, fill = factor(hsc8_T1))) + geom_histogram(binwidth = 1) #視覚化

#hsc9_T1の度数分布
hsc9_T1_count <- dplyr::count(InputData, hsc9_T1)
knitr::kable(hsc9_T1_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = hsc9_T1, fill = factor(hsc9_T1))) + geom_histogram(binwidth = 1) #視覚化

#hsc10_T1の度数分布
hsc10_T1_count <- dplyr::count(InputData, hsc10_T1)
knitr::kable(hsc10_T1_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = hsc10_T1, fill = factor(hsc10_T1))) + geom_histogram(binwidth = 1) #視覚化

#hsc11_T1の度数分布
hsc11_T1_count <- dplyr::count(InputData, hsc11_T1)
knitr::kable(hsc11_T1_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = hsc11_T1, fill = factor(hsc11_T1))) + geom_histogram(binwidth = 1) #視覚化

#hsc12_T1の度数分布
hsc12_T1_count <- dplyr::count(InputData, hsc12_T1)
knitr::kable(hsc12_T1_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = hsc12_T1, fill = factor(hsc12_T1))) + geom_histogram(binwidth = 1) #視覚化

#eoe_mean_T1の度数分布
eoe_T1_count <- dplyr::count(InputData, eoe_mean_T1)
knitr::kable(eoe_T1_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = eoe_mean_T1, fill = factor(eoe_mean_T1))) + geom_histogram(binwidth = 0.2) #視覚化

#lst_mean_T1の度数分布
lst_T1_count <- dplyr::count(InputData, lst_mean_T1)
knitr::kable(lst_T1_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = lst_mean_T1, fill = factor(lst_mean_T1))) + geom_histogram(binwidth = 0.4) #視覚化

#aes_mean_T1の度数分布
aes_T1_count <- dplyr::count(InputData, aes_mean_T1)
knitr::kable(aes_T1_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = aes_mean_T1, fill = factor(aes_mean_T1))) + geom_histogram(binwidth = 0.3) #視覚化

#hsc_mean_T1の度数分布
hsc_T1_count <- dplyr::count(InputData, hsc_mean_T1)
knitr::kable(hsc_T1_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = hsc_mean_T1, fill = factor(hsc_mean_T1))) + 
  geom_histogram(binwidth = 0.3) + guides(fill = "none") #視覚化

#hsc1_T2の度数分布
hsc1_T2_count <- dplyr::count(InputData, hsc1_T2)
knitr::kable(hsc1_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = hsc1_T2, fill = factor(hsc1_T2))) + geom_histogram(binwidth = 1) #視覚化

#hsc2_T2の度数分布
hsc2_T2_count <- dplyr::count(InputData, hsc2_T2)
knitr::kable(hsc2_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = hsc2_T2, fill = factor(hsc2_T2))) + geom_histogram(binwidth = 1) #視覚化

#hsc3_T2の度数分布
hsc3_T2_count <- dplyr::count(InputData, hsc3_T2)
knitr::kable(hsc3_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = hsc3_T2, fill = factor(hsc3_T2))) + geom_histogram(binwidth = 1) #視覚化

#hsc4_T2の度数分布
hsc4_T2_count <- dplyr::count(InputData, hsc4_T2)
knitr::kable(hsc4_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = hsc4_T2, fill = factor(hsc4_T2))) + geom_histogram(binwidth = 1) #視覚化

#hsc5_T2の度数分布
hsc5_T2_count <- dplyr::count(InputData, hsc5_T2)
knitr::kable(hsc5_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = hsc5_T2, fill = factor(hsc5_T2))) + geom_histogram(binwidth = 1) #視覚化

#hsc6_T2の度数分布
hsc6_T2_count <- dplyr::count(InputData, hsc6_T2)
knitr::kable(hsc6_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = hsc6_T2, fill = factor(hsc6_T2))) + geom_histogram(binwidth = 1) #視覚化

#hsc7_T2の度数分布
hsc7_T2_count <- dplyr::count(InputData, hsc7_T2)
knitr::kable(hsc7_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = hsc7_T2, fill = factor(hsc7_T2))) + geom_histogram(binwidth = 1) #視覚化

#hsc8_T2の度数分布
hsc8_T2_count <- dplyr::count(InputData, hsc8_T2)
knitr::kable(hsc8_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = hsc8_T2, fill = factor(hsc8_T2))) + geom_histogram(binwidth = 1) #視覚化

#hsc9_T2の度数分布
hsc9_T2_count <- dplyr::count(InputData, hsc9_T2)
knitr::kable(hsc9_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = hsc9_T2, fill = factor(hsc9_T2))) + geom_histogram(binwidth = 1) #視覚化

#hsc10_T2の度数分布
hsc10_T2_count <- dplyr::count(InputData, hsc10_T2)
knitr::kable(hsc10_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = hsc10_T2, fill = factor(hsc10_T2))) + geom_histogram(binwidth = 1) #視覚化

#hsc11_T2の度数分布
hsc11_T2_count <- dplyr::count(InputData, hsc11_T2)
knitr::kable(hsc11_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = hsc11_T2, fill = factor(hsc11_T2))) + geom_histogram(binwidth = 1) #視覚化

#hsc12_T2の度数分布
hsc12_T2_count <- dplyr::count(InputData, hsc12_T2)
knitr::kable(hsc12_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = hsc12_T2, fill = factor(hsc12_T2))) + geom_histogram(binwidth = 1) #視覚化

#eoe_mean_T2の度数分布
eoe_T2_count <- dplyr::count(InputData, eoe_mean_T2)
knitr::kable(eoe_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = eoe_mean_T2, fill = factor(eoe_mean_T2))) + geom_histogram(binwidth = 0.2) #視覚化

#lst_mean_T2の度数分布
lst_T2_count <- dplyr::count(InputData, lst_mean_T2)
knitr::kable(lst_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = lst_mean_T2, fill = factor(lst_mean_T2))) + geom_histogram(binwidth = 0.4) #視覚化

#aes_mean_T2の度数分布
aes_T2_count <- dplyr::count(InputData, aes_mean_T2)
knitr::kable(aes_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = aes_mean_T2, fill = factor(aes_mean_T2))) + geom_histogram(binwidth = 0.3) #視覚化

#hsc_mean_T2の度数分布
hsc_T2_count <- dplyr::count(InputData, hsc_mean_T2)
knitr::kable(hsc_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = hsc_mean_T2, fill = factor(hsc_mean_T2))) + 
  geom_histogram(binwidth = 0.3) + guides(fill = "none") #視覚化
```

###2-1-3. 精神的健康の度数分布
```{r count_health, include = TRUE}
#health1_T1の度数分布
health1_T1_count <- dplyr::count(InputData, health1_T1)
knitr::kable(health1_T1_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = health1_T1, fill = factor(health1_T1))) + geom_histogram(binwidth = 1) #視覚化

#health2_T1の度数分布
health2_T1_count <- dplyr::count(InputData, health2_T1)
knitr::kable(health2_T1_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = health2_T1, fill = factor(health2_T1))) + geom_histogram(binwidth = 1) #視覚化

#health3_T1の度数分布
health3_T1_count <- dplyr::count(InputData, health3_T1)
knitr::kable(health3_T1_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = health3_T1, fill = factor(health3_T1))) + geom_histogram(binwidth = 1) #視覚化

#health4_T1の度数分布
health4_T1_count <- dplyr::count(InputData, health4_T1)
knitr::kable(health4_T1_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = health4_T1, fill = factor(health4_T1))) + geom_histogram(binwidth = 1) #視覚化

#health5_T1の度数分布
health5_T1_count <- dplyr::count(InputData, health5_T1)
knitr::kable(health5_T1_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = health5_T1, fill = factor(health5_T1))) + geom_histogram(binwidth = 1) #視覚化

#health_mean_T1の度数分布
health_mean_T1_count <- dplyr::count(InputData, health_mean_T1)
knitr::kable(health_mean_T1_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = health_mean_T1, fill = factor(health_mean_T1))) + geom_histogram(binwidth = 0.2) #視覚化

#health1_T2の度数分布
health1_T2_count <- dplyr::count(InputData, health1_T2)
knitr::kable(health1_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = health1_T2, fill = factor(health1_T2))) + geom_histogram(binwidth = 1) #視覚化

#health2_T2の度数分布
health2_T2_count <- dplyr::count(InputData, health2_T2)
knitr::kable(health2_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = health2_T2, fill = factor(health2_T2))) + geom_histogram(binwidth = 1) #視覚化

#health3_T2の度数分布
health3_T2_count <- dplyr::count(InputData, health3_T2)
knitr::kable(health3_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = health3_T2, fill = factor(health3_T2))) + geom_histogram(binwidth = 1) #視覚化

#health4_T2の度数分布
health4_T2_count <- dplyr::count(InputData, health4_T2)
knitr::kable(health4_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = health4_T2, fill = factor(health4_T2))) + geom_histogram(binwidth = 1) #視覚化

#health5_T2の度数分布
health5_T2_count <- dplyr::count(InputData, health5_T2)
knitr::kable(health5_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = health5_T2, fill = factor(health5_T2))) + geom_histogram(binwidth = 1) #視覚化

#health_mean_T2の度数分布
health_mean_T2_count <- dplyr::count(InputData, health_mean_T2)
knitr::kable(health_mean_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = health_mean_T2, fill = factor(health_mean_T2))) + geom_histogram(binwidth = 0.2) #視覚化
```

###2-1-4. PANASの度数分布
```{r count_panas, include = TRUE}
#panas1_T1の度数分布
panas1_T1_count <- dplyr::count(InputData, panas1_T1)
knitr::kable(panas1_T1_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = panas1_T1, fill = factor(panas1_T1))) + geom_histogram(binwidth = 1) #視覚化

#panas2_T1の度数分布
panas2_T1_count <- dplyr::count(InputData, panas2_T1)
knitr::kable(panas2_T1_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = panas2_T1, fill = factor(panas2_T1))) + geom_histogram(binwidth = 1) #視覚化

#panas3_T1の度数分布
panas3_T1_count <- dplyr::count(InputData, panas3_T1)
knitr::kable(panas3_T1_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = panas3_T1, fill = factor(panas3_T1))) + geom_histogram(binwidth = 1) #視覚化

#panas4_T1の度数分布
panas4_T1_count <- dplyr::count(InputData, panas4_T1)
knitr::kable(panas4_T1_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = panas4_T1, fill = factor(panas4_T1))) + geom_histogram(binwidth = 1) #視覚化

#panas5_T1の度数分布
panas5_T1_count <- dplyr::count(InputData, panas5_T1)
knitr::kable(panas5_T1_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = panas5_T1, fill = factor(panas5_T1))) + geom_histogram(binwidth = 1) #視覚化

#panas6_T1の度数分布
panas6_T1_count <- dplyr::count(InputData, panas6_T1)
knitr::kable(panas6_T1_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = panas6_T1, fill = factor(panas6_T1))) + geom_histogram(binwidth = 1) #視覚化

#panas7_T1の度数分布
panas7_T1_count <- dplyr::count(InputData, panas7_T1)
knitr::kable(panas7_T1_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = panas7_T1, fill = factor(panas7_T1))) + geom_histogram(binwidth = 1) #視覚化

#panas8_T1の度数分布
panas8_T1_count <- dplyr::count(InputData, panas8_T1)
knitr::kable(panas8_T1_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = panas8_T1, fill = factor(panas8_T1))) + geom_histogram(binwidth = 1) #視覚化

#panas9_T1の度数分布
panas9_T1_count <- dplyr::count(InputData, panas9_T1)
knitr::kable(panas9_T1_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = panas9_T1, fill = factor(panas9_T1))) + geom_histogram(binwidth = 1) #視覚化

#panas10_T1の度数分布
panas10_T1_count <- dplyr::count(InputData, panas10_T1)
knitr::kable(panas10_T1_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = panas10_T1, fill = factor(panas10_T1))) + geom_histogram(binwidth = 1) #視覚化

#panas11_T1の度数分布
panas11_T1_count <- dplyr::count(InputData, panas11_T1)
knitr::kable(panas11_T1_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = panas11_T1, fill = factor(panas11_T1))) + geom_histogram(binwidth = 1) #視覚化

#panas12_T1の度数分布
panas12_T1_count <- dplyr::count(InputData, panas12_T1)
knitr::kable(panas12_T1_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = panas12_T1, fill = factor(panas12_T1))) + geom_histogram(binwidth = 1) #視覚化

#panas13_T1の度数分布
panas13_T1_count <- dplyr::count(InputData, panas13_T1)
knitr::kable(panas13_T1_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = panas13_T1, fill = factor(panas13_T1))) + geom_histogram(binwidth = 1) #視覚化

#panas14_T1の度数分布
panas14_T1_count <- dplyr::count(InputData, panas14_T1)
knitr::kable(panas14_T1_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = panas14_T1, fill = factor(panas14_T1))) + geom_histogram(binwidth = 1) #視覚化

#panas15_T1の度数分布
panas15_T1_count <- dplyr::count(InputData, panas15_T1)
knitr::kable(panas15_T1_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = panas15_T1, fill = factor(panas15_T1))) + geom_histogram(binwidth = 1) #視覚化

#panas16_T1の度数分布
panas16_T1_count <- dplyr::count(InputData, panas16_T1)
knitr::kable(panas16_T1_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = panas16_T1, fill = factor(panas16_T1))) + geom_histogram(binwidth = 1) #視覚化

#positive_T1の度数分布
positive_T1_count <- dplyr::count(InputData, positive_mean_T1)
knitr::kable(positive_T1_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = positive_mean_T1, fill = factor(positive_mean_T1))) + geom_histogram(binwidth = 0.3) #視覚化

#negative_T1の度数分布
negative_T1_count <- dplyr::count(InputData, negative_mean_T1)
knitr::kable(negative_T1_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = negative_mean_T1, fill = factor(negative_mean_T1))) + geom_histogram(binwidth = 0.2) #視覚化
```

###2-1-5. 学校環境変化の度数分布
```{r count_environment, include = TRUE}
#environment1_T2の度数分布
environment1_T2_count <- dplyr::count(InputData, environment1_T2)
knitr::kable(environment1_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = environment1_T2, fill = factor(environment1_T2))) + geom_histogram(binwidth = 1) #視覚化

#environment2_T2の度数分布
environment2_T2_count <- dplyr::count(InputData, environment2_T2)
knitr::kable(environment2_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = environment2_T2, fill = factor(environment2_T2))) + geom_histogram(binwidth = 1) #視覚化

#environment3_T2の度数分布
environment3_T2_count <- dplyr::count(InputData, environment3_T2)
knitr::kable(environment3_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = environment3_T2, fill = factor(environment3_T2))) + geom_histogram(binwidth = 1) #視覚化

#environment4_T2の度数分布
environment4_T2_count <- dplyr::count(InputData, environment4_T2)
knitr::kable(environment4_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = environment4_T2, fill = factor(environment4_T2))) + geom_histogram(binwidth = 1) #視覚化

#environment5_T2の度数分布
environment5_T2_count <- dplyr::count(InputData, environment5_T2)
knitr::kable(environment5_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = environment5_T2, fill = factor(environment5_T2))) + geom_histogram(binwidth = 1) #視覚化

#environment6_T2の度数分布
environment6_T2_count <- dplyr::count(InputData, environment6_T2)
knitr::kable(environment6_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = environment6_T2, fill = factor(environment6_T2))) + geom_histogram(binwidth = 1) #視覚化

#environment7_T2の度数分布
environment7_T2_count <- dplyr::count(InputData, environment7_T2)
knitr::kable(environment7_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = environment7_T2, fill = factor(environment7_T2))) + geom_histogram(binwidth = 1) #視覚化

#environment8_T2の度数分布
environment8_T2_count <- dplyr::count(InputData, environment8_T2)
knitr::kable(environment8_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = environment8_T2, fill = factor(environment8_T2))) + geom_histogram(binwidth = 1) #視覚化

#environment9_T2の度数分布
environment9_T2_count <- dplyr::count(InputData, environment9_T2)
knitr::kable(environment9_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = environment9_T2, fill = factor(environment9_T2))) + geom_histogram(binwidth = 1) #視覚化

#environment10_T2の度数分布
environment10_T2_count <- dplyr::count(InputData, environment10_T2)
knitr::kable(environment10_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = environment10_T2, fill = factor(environment10_T2))) + geom_histogram(binwidth = 1) #視覚化

#environment11_T2の度数分布
environment11_T2_count <- dplyr::count(InputData, environment11_T2)
knitr::kable(environment11_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = environment11_T2, fill = factor(environment11_T2))) + geom_histogram(binwidth = 1) #視覚化

#environment11_T2の度数分布
environment_mean_T2_count <- dplyr::count(InputData, environment_mean_T2)
knitr::kable(environment_mean_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = environment_mean_T2, fill = factor(environment_mean_T2))) + 
  geom_histogram(binwidth = 0.2) +
  guides(fill = "none")#視覚化
```

###2-1-6. BISの度数分布
```{r count_bis, include = TRUE}
#bis1_T2の度数分布
bis1_T2_count <- dplyr::count(InputData, bis1_T2)
knitr::kable(bis1_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = bis1_T2, fill = factor(bis1_T2))) + geom_histogram(binwidth = 1) #視覚化

#bis2_T2の度数分布
bis2_T2_count <- dplyr::count(InputData, bis2_T2)
knitr::kable(bis2_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = bis2_T2, fill = factor(bis2_T2))) + geom_histogram(binwidth = 1) #視覚化

#bis3_T2の度数分布
bis3_T2_count <- dplyr::count(InputData, bis3_T2)
knitr::kable(bis3_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = bis3_T2, fill = factor(bis3_T2))) + geom_histogram(binwidth = 1) #視覚化

#bis4_T2の度数分布
bis4_T2_count <- dplyr::count(InputData, bis4_T2)
knitr::kable(bis4_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = bis4_T2, fill = factor(bis4_T2))) + geom_histogram(binwidth = 1) #視覚化

#bis5_T2の度数分布
bis5_T2_count <- dplyr::count(InputData, bis5_T2)
knitr::kable(bis5_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = bis5_T2, fill = factor(bis5_T2))) + geom_histogram(binwidth = 1) #視覚化

#bis6_T2の度数分布
bis6_T2_count <- dplyr::count(InputData, bis6_T2)
knitr::kable(bis6_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = bis6_T2, fill = factor(bis6_T2))) + geom_histogram(binwidth = 1) #視覚化

#bis7_T2の度数分布
bis7_T2_count <- dplyr::count(InputData, bis7_T2)
knitr::kable(bis7_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = bis7_T2, fill = factor(bis7_T2))) + geom_histogram(binwidth = 1) #視覚化

#bis_mean_T2の度数分布
bis_mean_T2_count <- dplyr::count(InputData, bis_mean_T2)
knitr::kable(bis_mean_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = bis_mean_T2, fill = factor(bis_mean_T2))) + 
  geom_histogram(binwidth = 0.1) + 
  guides(fill = "none") #視覚化
```

###2-1-7. BASの度数分布
```{r count_bas, include = TRUE}
#bas1_T2の度数分布
bas1_T2_count <- dplyr::count(InputData, bas1_T2)
knitr::kable(bas1_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = bas1_T2, fill = factor(bas1_T2))) + geom_histogram(binwidth = 1) #視覚化

#bas2_T2の度数分布
bas2_T2_count <- dplyr::count(InputData, bas2_T2)
knitr::kable(bas2_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = bas2_T2, fill = factor(bas2_T2))) + geom_histogram(binwidth = 1) #視覚化

#bas3_T2の度数分布
bas3_T2_count <- dplyr::count(InputData, bas3_T2)
knitr::kable(bas3_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = bas3_T2, fill = factor(bas3_T2))) + geom_histogram(binwidth = 1) #視覚化

#bas4_T2の度数分布
bas4_T2_count <- dplyr::count(InputData, bas4_T2)
knitr::kable(bas4_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = bas4_T2, fill = factor(bas4_T2))) + geom_histogram(binwidth = 1) #視覚化

#bas5_T2の度数分布
bas5_T2_count <- dplyr::count(InputData, bas5_T2)
knitr::kable(bas5_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = bas5_T2, fill = factor(bas5_T2))) + geom_histogram(binwidth = 1) #視覚化

#bas6_T2の度数分布
bas6_T2_count <- dplyr::count(InputData, bas6_T2)
knitr::kable(bas6_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = bas6_T2, fill = factor(bas6_T2))) + geom_histogram(binwidth = 1) #視覚化

#bas7_T2の度数分布
bas7_T2_count <- dplyr::count(InputData, bas7_T2)
knitr::kable(bas7_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = bas7_T2, fill = factor(bas7_T2))) + geom_histogram(binwidth = 1) #視覚化

#bas8_T2の度数分布
bas8_T2_count <- dplyr::count(InputData, bas8_T2)
knitr::kable(bas8_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = bas8_T2, fill = factor(bas8_T2))) + geom_histogram(binwidth = 1) #視覚化

#bas9_T2の度数分布
bas9_T2_count <- dplyr::count(InputData, bas9_T2)
knitr::kable(bas9_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = bas9_T2, fill = factor(bas9_T2))) + geom_histogram(binwidth = 1) #視覚化

#bas10_T2の度数分布
bas10_T2_count <- dplyr::count(InputData, bas10_T2)
knitr::kable(bas10_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = bas10_T2, fill = factor(bas10_T2))) + geom_histogram(binwidth = 1) #視覚化

#bas11_T2の度数分布
bas11_T2_count <- dplyr::count(InputData, bas11_T2)
knitr::kable(bas11_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = bas11_T2, fill = factor(bas11_T2))) + geom_histogram(binwidth = 1) #視覚化

#bas12_T2の度数分布
bas12_T2_count <- dplyr::count(InputData, bas12_T2)
knitr::kable(bas12_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = bas12_T2, fill = factor(bas12_T2))) + geom_histogram(binwidth = 1) #視覚化

#bas13_T2の度数分布
bas13_T2_count <- dplyr::count(InputData, bas13_T2)
knitr::kable(bas13_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = bas13_T2, fill = factor(bas13_T2))) + geom_histogram(binwidth = 1) #視覚化

#bas_mean_T2の度数分布
bas_mean_T2_count <- dplyr::count(InputData, bas_mean_T2)
knitr::kable(bas_mean_T2_count) #テーブル化
ggplot(data = InputData, mapping = aes(x = bas_mean_T2, fill = factor(bas_mean_T2))) + 
  geom_histogram(binwidth = 0.2) + 
  guides(fill = "none") #視覚化
```

##2-2. 全変数の記述統計量

```{r discriptive_all_variables, include = TRUE}
summary(InputData) #一気に出力（SDは出力されない）
```

###2-2-1. HSC_T1の記述統計量
```{r discript_hscsT1, include = TRUE}
hsc_T1_discriptive <- 
  InputData %>% 
  dplyr::summarise(n = n (), #グループの人数を出力
                   hsc1.T1.mean = mean (hsc1_T1), #hsc1_T1の平均
                   hsc1.T1.sd = sd (hsc1_T1), #hsc1_T1のSD
                   hsc2.T1.mean = mean (hsc2_T1), 
                   hsc2.T1.sd = sd (hsc2_T1),
                   hsc3.T1.mean = mean (hsc3_T1), 
                   hsc3.T1.sd = sd (hsc3_T1),
                   hsc4.T1.mean = mean (hsc4_T1), 
                   hsc4.T1.sd = sd (hsc4_T1),
                   hsc5.T1.mean = mean (hsc5_T1), 
                   hsc5.T1.sd = sd (hsc5_T1),
                   hsc6.T1.mean = mean (hsc6_T1), 
                   hsc6.T1.sd = sd (hsc6_T1),
                   hsc7.T1.mean = mean (hsc7_T1), 
                   hsc7.T1.sd = sd (hsc7_T1),
                   hsc8.T1.mean = mean (hsc8_T1), 
                   hsc8.T1.sd = sd (hsc8_T1),
                   hsc9.T1.mean = mean (hsc9_T1), 
                   hsc9.T1.sd = sd (hsc9_T1),
                   hsc10.T1.mean = mean (hsc10_T1), 
                   hsc10.T1.sd = sd (hsc10_T1),
                   hsc11.T1.mean = mean (hsc11_T1), 
                   hsc11.T1.sd = sd (hsc11_T1),
                   hsc12.T1.mean = mean (hsc4_T1), 
                   hsc12.T1.sd = sd (hsc4_T1),
                   eoe.mean.T1 = mean (eoe_mean_T1),
                   eoe.sd.T1 = sd (eoe_mean_T1),
                   lst.mean.T1 = mean (lst_mean_T1),
                   lst.sd.T1 = sd (lst_mean_T1),
                   aes.mean.T1 = mean (aes_mean_T1),
                   aes.sd.T1 = sd (aes_mean_T1),
                   hsc.mean.T1 = mean (hsc_mean_T1),
                   hsc.sd.T1 = sd (hsc_mean_T1)) 
#ditydataにしたほうがbetter

knitr::kable(hsc_T1_discriptive, digits = 2) #出力
```

###2-2-2. HSC_T2の記述統計量
```{r discript_hscT2, include = TRUE}
hsc_T2_discriptive <- 
  InputData %>% 
  drop_na() %>% #T2は欠損値があるのでdrop_na()を挟む
  dplyr::summarise(n = n (), #グループの人数を出力
                   hsc1.T2.mean = mean (hsc1_T2), #hsc1_T2の平均
                   hsc1.T2.sd = sd (hsc1_T2), #hsc1_T2のSD
                   hsc2.T2.mean = mean (hsc2_T2), 
                   hsc2.T2.sd = sd (hsc2_T2),
                   hsc3.T2.mean = mean (hsc3_T2), 
                   hsc3.T2.sd = sd (hsc3_T2),
                   hsc4.T2.mean = mean (hsc4_T2), 
                   hsc4.T2.sd = sd (hsc4_T2),
                   hsc5.T2.mean = mean (hsc5_T2), 
                   hsc5.T2.sd = sd (hsc5_T2),
                   hsc6.T2.mean = mean (hsc6_T2), 
                   hsc6.T2.sd = sd (hsc6_T2),
                   hsc7.T2.mean = mean (hsc7_T2), 
                   hsc7.T2.sd = sd (hsc7_T2),
                   hsc8.T2.mean = mean (hsc8_T2), 
                   hsc8.T2.sd = sd (hsc8_T2),
                   hsc9.T2.mean = mean (hsc9_T2), 
                   hsc9.T2.sd = sd (hsc9_T2),
                   hsc10.T2.mean = mean (hsc10_T2), 
                   hsc10.T2.sd = sd (hsc10_T2),
                   hsc11.T2.mean = mean (hsc11_T2), 
                   hsc11.T2.sd = sd (hsc11_T2),
                   hsc12.T2.mean = mean (hsc4_T2), 
                   hsc12.T2.sd = sd (hsc4_T2),
                   eoe.mean.T2 = mean (eoe_mean_T2),
                   eoe.sd.T2 = sd (eoe_mean_T2),
                   lst.mean.T2 = mean (lst_mean_T2),
                   lst.sd.T2 = sd (lst_mean_T2),
                   aes.mean.T2 = mean (aes_mean_T2),
                   aes.sd.T2 = sd (aes_mean_T2),
                   hsc.mean.T2 = mean (hsc_mean_T2),
                   hsc.sd.T2 = sd (hsc_mean_T2))
#ditydataにしたほうがbetter

knitr::kable(hsc_T2_discriptive, digits = 2) #出力
```

###2-2-3. 精神的健康_T1の記述統計量
```{r discript_healthT1, include = TRUE}
health_T1_discriptive <- 
  InputData %>% 
  dplyr::summarise(n = n (), #グループの人数を出力
                   health1.T1.mean = mean (health1_T1), #health1_T1の平均
                   health1.T1.sd = sd (health1_T1), #health1_T1のSD
                   health2.T1.mean = mean (health2_T1), 
                   health2.T1.sd = sd (health2_T1),
                   health3.T1.mean = mean (health3_T1), 
                   health3.T1.sd = sd (health3_T1),
                   health4.T1.mean = mean (health4_T1), 
                   health4.T1.sd = sd (health4_T1),
                   health5.T1.mean = mean (health5_T1), 
                   health5.T1.sd = sd (health5_T1),
                   health.mean.T1 = mean (health_mean_T1),
                   health.sd.T1 = sd (health_mean_T1))

knitr::kable(health_T1_discriptive, digits = 2) #出力
```

###2-2-4. 精神的健康_T2の記述統計量
```{r discript_healthT2, include = TRUE}
health_T2_discriptive <- 
  InputData %>% 
  drop_na() %>%
  dplyr::summarise(n = n (), #グループの人数を出力
                   health1.T2.mean = mean (health1_T2), #health1_T2の平均
                   health1.T2.sd = sd (health1_T2), #health1_T2のSD
                   health2.T2.mean = mean (health2_T2), 
                   health2.T2.sd = sd (health2_T2),
                   health3.T2.mean = mean (health3_T2), 
                   health3.T2.sd = sd (health3_T2),
                   health4.T2.mean = mean (health4_T2), 
                   health4.T2.sd = sd (health4_T2),
                   health5.T2.mean = mean (health5_T2), 
                   health5.T2.sd = sd (health5_T2),
                   health.mean.T2 = mean (health_mean_T2),
                   health.sd.T2 = sd (health_mean_T2))

knitr::kable(health_T2_discriptive, digits = 2) #出力
```

###2-2-5. PANAS_T1の記述統計量
```{r discript_panasT1, include = TRUE}
panas_T1_discriptive <- 
  InputData %>% 
  dplyr::summarise(n = n (), #グループの人数を出力
                   panas1.T1.mean = mean (panas1_T1), #panas1_T1の平均
                   panas1.T1.sd = sd (panas1_T1), #panas1_T1のSD
                   panas2.T1.mean = mean (panas2_T1), 
                   panas2.T1.sd = sd (panas2_T1),
                   panas3.T1.mean = mean (panas3_T1), 
                   panas3.T1.sd = sd (panas3_T1),
                   panas4.T1.mean = mean (panas4_T1), 
                   panas4.T1.sd = sd (panas4_T1),
                   panas5.T1.mean = mean (panas5_T1), 
                   panas5.T1.sd = sd (panas5_T1),
                   panas6.T1.mean = mean (panas6_T1), 
                   panas6.T1.sd = sd (panas6_T1),
                   panas7.T1.mean = mean (panas7_T1), 
                   panas7.T1.sd = sd (panas7_T1),
                   panas8.T1.mean = mean (panas8_T1), 
                   panas8.T1.sd = sd (panas8_T1),
                   panas9.T1.mean = mean (panas9_T1), 
                   panas9.T1.sd = sd (panas9_T1),
                   panas10.T1.mean = mean (panas10_T1), 
                   panas10.T1.sd = sd (panas10_T1),
                   panas11.T1.mean = mean (panas11_T1), 
                   panas11.T1.sd = sd (panas11_T1),
                   panas12.T1.mean = mean (panas12_T1), 
                   panas12.T1.sd = sd (panas12_T1),
                   panas13.T1.mean = mean (panas13_T1), 
                   panas13.T1.sd = sd (panas13_T1),
                   panas14.T1.mean = mean (panas14_T1), 
                   panas14.T1.sd = sd (panas14_T1),
                   panas15.T1.mean = mean (panas15_T1), 
                   panas15.T1.sd = sd (panas15_T1),
                   panas16.T1.mean = mean (panas16_T1), 
                   panas16.T1.sd = sd (panas16_T1),
                   positive.mean.T1 = mean (positive_mean_T1),
                   positive.sd.T1 = sd (positive_mean_T1),
                   negative.mean.T1 = mean (negative_mean_T1),
                   negative.sd.T1 = sd (negative_mean_T1))

knitr::kable(panas_T1_discriptive, digits = 2) #出力
```

###2-2-6. 学校環境変化_T2の記述統計量
```{r discript_envT1, include = TRUE}
environment_T2_discriptive <- 
  InputData %>% 
  drop_na() %>%
  dplyr::summarise(n = n (), #グループの人数を出力
                   environment1.T2.mean = mean (environment1_T2), #environment1_T2の平均
                   environment1.T2.sd = sd (environment1_T2), #environment1_T2のSD
                   environment2.T2.mean = mean (environment2_T2), 
                   environment2.T2.sd = sd (environment2_T2),
                   environment3.T2.mean = mean (environment3_T2), 
                   environment3.T2.sd = sd (environment3_T2),
                   environment4.T2.mean = mean (environment4_T2), 
                   environment4.T2.sd = sd (environment4_T2),
                   environment5.T2.mean = mean (environment5_T2), 
                   environment5.T2.sd = sd (environment5_T2),
                   environment6.T2.mean = mean (environment6_T2), 
                   environment6.T2.sd = sd (environment6_T2),
                   environment7.T2.mean = mean (environment7_T2), 
                   environment7.T2.sd = sd (environment7_T2),
                   environment8.T2.mean = mean (environment8_T2), 
                   environment8.T2.sd = sd (environment8_T2),
                   environment9.T2.mean = mean (environment9_T2), 
                   environment9.T2.sd = sd (environment9_T2),
                   environment10.T2.mean = mean (environment10_T2), 
                   environment10.T2.sd = sd (environment10_T2),
                   environment11.T2.mean = mean (environment11_T2), 
                   environment11.T2.sd = sd (environment11_T2),
                   environment.T2.mean = mean (environment_mean_T2),
                   environment.T2.sd = sd (environment_mean_T2))
                   
knitr::kable(environment_T2_discriptive, digits = 2) #出力
```

###2-2-7. BIS_T2の記述統計量
```{r discript_bisT2, include = TRUE}
bis_T2_discriptive <- 
  InputData %>% 
  drop_na() %>%
  dplyr::summarise(n = n (), #グループの人数を出力
                   bis1.T2.mean = mean (bis1_T2), #bis1_T2の平均
                   bis1.T2.sd = sd (bis1_T2), #bis1_T2のSD
                   bis2.T2.mean = mean (bis2_T2), 
                   bis2.T2.sd = sd (bis2_T2),
                   bis3.T2.mean = mean (bis3_T2), 
                   bis3.T2.sd = sd (bis3_T2),
                   bis4.T2.mean = mean (bis4_T2), 
                   bis4.T2.sd = sd (bis4_T2),
                   bis5.T2.mean = mean (bis5_T2), 
                   bis5.T2.sd = sd (bis5_T2),
                   bis6.T2.mean = mean (bis6_T2), 
                   bis6.T2.sd = sd (bis6_T2),
                   bis7.T2.mean = mean (bis7_T2), 
                   bis7.T2.sd = sd (bis7_T2),
                   bis.T2.mean = mean (bis_mean_T2), 
                   bis.T2.sd = sd (bis_mean_T2))

knitr::kable(bis_T2_discriptive, digits = 2) #出力
```

###2-2-8. BAS_T2の記述統計量
```{r discript_basT2, include = TRUE}
bas_T2_discriptive <- 
  InputData %>% 
  drop_na() %>%
  dplyr::summarise(n = n (), #グループの人数を出力
                   bas1.T2.mean = mean (bas1_T2), #bas1_T2の平均
                   bas1.T2.sd = sd (bas1_T2), #bas1_T2のSD
                   bas2.T2.mean = mean (bas2_T2), 
                   bas2.T2.sd = sd (bas2_T2),
                   bas3.T2.mean = mean (bas3_T2), 
                   bas3.T2.sd = sd (bas3_T2),
                   bas4.T2.mean = mean (bas4_T2), 
                   bas4.T2.sd = sd (bas4_T2),
                   bas5.T2.mean = mean (bas5_T2), 
                   bas5.T2.sd = sd (bas5_T2),
                   bas6.T2.mean = mean (bas6_T2), 
                   bas6.T2.sd = sd (bas6_T2),
                   bas7.T2.mean = mean (bas7_T2), 
                   bas7.T2.sd = sd (bas7_T2),
                   bas8.T2.mean = mean (bas8_T2), 
                   bas8.T2.sd = sd (bas8_T2),
                   bas9.T2.mean = mean (bas9_T2), 
                   bas9.T2.sd = sd (bas9_T2),
                   bas10.T2.mean = mean (bas10_T2), 
                   bas10.T2.sd = sd (bas10_T2),
                   bas11.T2.mean = mean (bas11_T2), 
                   bas11.T2.sd = sd (bas11_T2),
                   bas12.T2.mean = mean (bas12_T2), 
                   bas12.T2.sd = sd (bas12_T2),
                   bas13.T2.mean = mean (bas13_T2), 
                   bas13.T2.sd = sd (bas13_T2),
                   bas.T2.mean = mean (bas_mean_T2), 
                   bas.T2.sd = sd (bas_mean_T2))

knitr::kable(bas_T2_discriptive, digits = 2) #出力
```

##2-3. メイン変数の性別ごとの記述統計量

###2-3-1. Time1変数の統計量
```{r discriptive_all_variables_by_genderT1, include = TRUE}
Time1_discriptive_by_gender <- 
  InputData %>% 
  dplyr::group_by(child_gender_T1) %>% #性別でグルーピング
  dplyr::summarise(n = n (), #グループの人数を出力
                   hsc_T1_mean = mean (hsc_mean_T1), #hsc_T1の平均
                   hsc_T1_sd = sd (hsc_mean_T1), #hcs_T1のSD
                   eoe_T1_mean = mean (eoe_mean_T1), #eoe_T1の平均
                   eoe_T1_sd = sd (eoe_mean_T1), #eoe_T1のSD
                   lst_T1_mean = mean (lst_mean_T1), #lst_T1の平均
                   lst_T1_sd = sd (lst_mean_T1), #lst_T1のSD
                   aes_T1_mean = mean (aes_mean_T1), #aes_T1の平均
                   aes_T1_sd = sd (aes_mean_T1), #aes_T1のSD
                   health_T1_mean = mean (health_mean_T1), #health_T1の平均
                   health_T1_sd = sd (health_mean_T1), #health_T1のSD
                   positive_T1_mean = mean (positive_mean_T1), #positive_T1の平均値
                   positive_T1_sd = sd (positive_mean_T1), #positive_T1のSD
                   negative_T1_mean = mean (negative_mean_T1), #negative_T1の平均値
                   negative_T1_sd = sd (negative_mean_T1)) #negative_T1のSD

knitr::kable(Time1_discriptive_by_gender, digits = 2) #出力
```

###2-3-2. Time2変数の統計量
```{r discriptive_all_variables_by_genderT2, include = TRUE}
Time2_discriptive_by_gender <- 
  InputData %>%
  drop_na() %>%
  dplyr::group_by(child_gender_T1) %>% #性別でグルーピング
  dplyr::summarise(n = n (), #グループの人数を出力
                   hsc_T2_mean = mean (hsc_mean_T2), #hsc_T2の平均
                   hsc_T2_sd = sd (hsc_mean_T2), #hcs_T2のSD
                   eoe_T2_mean = mean (eoe_mean_T2), #eoe_T2の平均
                   eoe_T2_sd = sd (eoe_mean_T2), #eoe_T2のSD
                   lst_T2_mean = mean (lst_mean_T2), #lst_T2の平均
                   lst_T2_sd = sd (lst_mean_T2), #lst_T2のSD
                   aes_T2_mean = mean (aes_mean_T2), #aes_T2の平均
                   aes_T2_sd = sd (aes_mean_T2), #aes_T2のSD
                   health_T2_mean = mean (health_mean_T2), #health_T2の平均
                   health_T2_sd = sd (health_mean_T2), #health_T2のSD
                   environment_T2_mean = mean (environment_mean_T2), #environment_T2の平均値
                   environment_T2_sd = sd (environment_mean_T2), #environment_T2のSD
                   bis_T2_mean = mean (bis_mean_T2), #bis_T2の平均値
                   bis_T2_sd = sd (bis_mean_T2), #bis_T2のSD
                   bas_T2_mean = mean (bas_mean_T2), #bas_T2の平均値
                   bas_T2_sd = sd (bas_mean_T2)) #bas_T2のSD) 

knitr::kable(Time2_discriptive_by_gender, digits = 2) #出力
```

##2-4. 信頼性係数
  * 出力の見方は<https://mumu.jpn.ph/forest/computer/2016/05/29/5049/>など
  * psychパッケージのomega関数を使用する
  * GPArotationパッケージも必要
  * omega(データ, nfactor=尺度の因子数, fm=推定法)
  * 因子数のデフォは3（1に指定するとエラー）
  * 推定法のデフォは最小残差法

```{r internal_consistency, include = TRUE}
library(psych)
library(GPArotation)
```

###2-4-1. hscT1
```{r hscT1_consistency, include = TRUE}
omega(InputData[,c(11:16, 18:22)],3, fm="ml") #hscT1
```

###2-4-2. hscT2
```{r hscT2_consistency, include = TRUE}
omega(InputData[,c(64:69, 71:75)],3, fm="ml") #hscT2
```

###2-4-3. eoeT1
```{r eoeT1_consistency, include = TRUE}
omega(InputData[,c(18,16,14,19,22)],3, fm="ml") #eoeT1
```

##2-4-4. eoeT2
```{r eoeT2_consistency, include = TRUE}
omega(InputData[,c(71,69,67,72,75)],3, fm="ml") #eoeT2
```

###2-4-5. lstT1
```{r lstT1_consistency, include = TRUE}
omega(InputData[,c(12,21)],2, fm="ml") #lstT1
```

###2-4-6. lstT2
```{r lstT2_consistency, include = TRUE}
omega(InputData[,c(65,74)],2, fm="ml") #lstT2
```

###2-4-7. aesT1
```{r aesT1_consistency, include = TRUE}
omega(InputData[,c(15,20,11,13)],3, fm="ml") #aesT1
```

###2-4-8. aesT2
```{r aesT2_consistency, include = TRUE}
omega(InputData[,c(68,73,64,66)],3, fm="ml") #aesT2
```

###2-4-9. mentalT1
```{r mentalT1_consistency, include = TRUE}
omega(InputData[,23:27],3, fm="ml") #mentalT1
```

###2-4-10. mentalT2
```{r mentalT2_consistency, include = TRUE}
omega(InputData[,76:80],3, fm="ml") #mentalT2
```

###2-4-11. positiveT1
```{r positiveT1_consistency, include = TRUE}
omega(InputData[,c(29,31,33,35,37,39,41,43)],3, fm="ml") #positiveT1
```

###2-4-12. negativeT1
```{r negativeT1_consistency, include = TRUE}
omega(InputData[,c(28,30,32,34,36,38,40,42)],3, fm="ml") #negativeT1
```

###2-4-13. environmentT2
```{r environmentT2_consistency, include = TRUE}
omega(InputData[,53:63],3, fm="ml") #environmentT2
```

###2-4-14. bisT2
```{r bisT2_consistency, include = TRUE}
omega(InputData[,c(101,86,91,93,95,102)],3, fm="ml") #bisT2
```

###2-4-15. basT2
```{r basT2_consistency, include = TRUE}
omega(InputData[,c(82,83,84,85,87,88,89,91,92,94,96,97,99)],3, fm="ml") #basT2
```

##2-5. 相関係数（zero-order）
  * 論文化に必要な変数間の相関係数を算出
  * 感想：一気に相関検定してくれるコードがあればいいのだが…。アナログな方法しか思いつかない

```{r cortest, include = TRUE}
#相関表1列目
cor.test(InputData$hsc_mean_T1, InputData$hsc_mean_T2, method = "pearson", digits = 2) #hscT1-hscT2の相関
cor.test(InputData$hsc_mean_T1, InputData$eoe_mean_T1, method = "pearson") #hscT1-eoeT1の相関
cor.test(InputData$hsc_mean_T1, InputData$eoe_mean_T2, method = "pearson") #hscT1-eoeT2の相関
cor.test(InputData$hsc_mean_T1, InputData$lst_mean_T1, method = "pearson") #hscT1-lstT1の相関
cor.test(InputData$hsc_mean_T1, InputData$lst_mean_T2, method = "pearson") #hscT1-lstT2の相関
cor.test(InputData$hsc_mean_T1, InputData$aes_mean_T1, method = "pearson") #hscT1-aesT1の相関
cor.test(InputData$hsc_mean_T1, InputData$aes_mean_T2, method = "pearson") #hscT1-aesT2の相関
cor.test(InputData$hsc_mean_T1, InputData$health_mean_T1, method = "pearson") #hscT1-healthT1の相関
cor.test(InputData$hsc_mean_T1, InputData$health_mean_T2, method = "pearson") #hscT1-healthT2の相関
cor.test(InputData$hsc_mean_T1, InputData$positive_mean_T1, method = "pearson") #hscT1-positiveT1の相関
cor.test(InputData$hsc_mean_T1, InputData$negative_mean_T1, method = "pearson") #hscT1-negativeT1の相関
cor.test(InputData$hsc_mean_T1, InputData$environment_mean_T2, method = "pearson") #hscT1-environmentT2の相関
cor.test(InputData$hsc_mean_T1, InputData$bis_mean_T2, method = "pearson") #hscT1-bisT2の相関
cor.test(InputData$hsc_mean_T1, InputData$bas_mean_T2, method = "pearson") #hscT1-basT2の相関

#相関表2列目
cor.test(InputData$hsc_mean_T2, InputData$eoe_mean_T1, method = "pearson") #hscT2-eoeT1の相関
cor.test(InputData$hsc_mean_T2, InputData$eoe_mean_T2, method = "pearson") #hscT2-eoeT2の相関
cor.test(InputData$hsc_mean_T2, InputData$lst_mean_T1, method = "pearson") #hscT2-lstT1の相関
cor.test(InputData$hsc_mean_T2, InputData$lst_mean_T2, method = "pearson") #hscT2-lstT2の相関
cor.test(InputData$hsc_mean_T2, InputData$aes_mean_T1, method = "pearson") #hscT2-aesT1の相関
cor.test(InputData$hsc_mean_T2, InputData$aes_mean_T2, method = "pearson") #hscT2-aesT2の相関
cor.test(InputData$hsc_mean_T2, InputData$health_mean_T1, method = "pearson") #hscT2-healthT1の相関
cor.test(InputData$hsc_mean_T2, InputData$health_mean_T2, method = "pearson") #hscT2-healthT2の相関
cor.test(InputData$hsc_mean_T2, InputData$positive_mean_T1, method = "pearson") #hscT2-positiveT1の相関
cor.test(InputData$hsc_mean_T2, InputData$negative_mean_T1, method = "pearson") #hscT2-negativeT1の相関
cor.test(InputData$hsc_mean_T2, InputData$environment_mean_T2, method = "pearson") #hscT2-envirionmentT2の相関
cor.test(InputData$hsc_mean_T2, InputData$bis_mean_T2, method = "pearson") #hscT2-bisT2の相関
cor.test(InputData$hsc_mean_T2, InputData$bas_mean_T2, method = "pearson") #hscT2-basT2の相関

#相関表3列目
cor.test(InputData$eoe_mean_T1, InputData$eoe_mean_T2, method = "pearson") #eoeT1-eoeT2の相関
cor.test(InputData$eoe_mean_T1, InputData$lst_mean_T1, method = "pearson") #eoeT1-lstT1の相関
cor.test(InputData$eoe_mean_T1, InputData$lst_mean_T2, method = "pearson") #eoeT1-lstT2の相関
cor.test(InputData$eoe_mean_T1, InputData$aes_mean_T1, method = "pearson") #eoeT1-aesT1の相関
cor.test(InputData$eoe_mean_T1, InputData$aes_mean_T2, method = "pearson") #eoeT1-aesT2の相関
cor.test(InputData$eoe_mean_T1, InputData$health_mean_T1, method = "pearson") #eoeT1-healthT1の相関
cor.test(InputData$eoe_mean_T1, InputData$health_mean_T2, method = "pearson") #eoeT1-healthT2の相関
cor.test(InputData$eoe_mean_T1, InputData$positive_mean_T1, method = "pearson") #eoeT1-positiveT1の相関
cor.test(InputData$eoe_mean_T1, InputData$negative_mean_T1, method = "pearson") #eoeT1-negativeT1の相関
cor.test(InputData$eoe_mean_T1, InputData$environment_mean_T2, method = "pearson") #eoeT1-envirionmentT2の相関
cor.test(InputData$eoe_mean_T1, InputData$bis_mean_T2, method = "pearson") #eoeT1-bisT2の相関
cor.test(InputData$eoe_mean_T1, InputData$bas_mean_T2, method = "pearson") #eoeT1-basT2の相関

#相関表4列目
cor.test(InputData$eoe_mean_T2, InputData$lst_mean_T1, method = "pearson") #eoeT2-lstT1の相関
cor.test(InputData$eoe_mean_T2, InputData$lst_mean_T2, method = "pearson") #eoeT2-lstT2の相関
cor.test(InputData$eoe_mean_T2, InputData$aes_mean_T1, method = "pearson") #eoeT2-aesT1の相関
cor.test(InputData$eoe_mean_T2, InputData$aes_mean_T2, method = "pearson") #eoeT2-aesT2の相関
cor.test(InputData$eoe_mean_T2, InputData$health_mean_T1, method = "pearson") #eoeT2-healthT1の相関
cor.test(InputData$eoe_mean_T2, InputData$health_mean_T2, method = "pearson") #eoeT2-healthT2の相関
cor.test(InputData$eoe_mean_T2, InputData$positive_mean_T1, method = "pearson") #eoeT2-positiveT1の相関
cor.test(InputData$eoe_mean_T2, InputData$negative_mean_T1, method = "pearson") #eoeT2-negativeT1の相関
cor.test(InputData$eoe_mean_T2, InputData$environment_mean_T2, method = "pearson") #eoeT2-envirionmentT2の相関
cor.test(InputData$eoe_mean_T2, InputData$bis_mean_T2, method = "pearson") #eoeT2-bisT2の相関
cor.test(InputData$eoe_mean_T2, InputData$bas_mean_T2, method = "pearson") #eoeT2-basT2の相関

#相関表5列目
cor.test(InputData$lst_mean_T1, InputData$lst_mean_T2, method = "pearson") #lstT1-lstT2の相関
cor.test(InputData$lst_mean_T1, InputData$aes_mean_T1, method = "pearson") #lstT1-aesT1の相関
cor.test(InputData$lst_mean_T1, InputData$aes_mean_T2, method = "pearson") #lstT1-aesT2の相関
cor.test(InputData$lst_mean_T1, InputData$health_mean_T1, method = "pearson") #lstT1-healthT1の相関
cor.test(InputData$lst_mean_T1, InputData$health_mean_T2, method = "pearson") #lstT1-healthT2の相関
cor.test(InputData$lst_mean_T1, InputData$positive_mean_T1, method = "pearson") #lstT1-positiveT1の相関
cor.test(InputData$lst_mean_T1, InputData$negative_mean_T1, method = "pearson") #lstT1-negativeT1の相関
cor.test(InputData$lst_mean_T1, InputData$environment_mean_T2, method = "pearson") #lstT1-envirionmentT2の相関
cor.test(InputData$lst_mean_T1, InputData$bis_mean_T2, method = "pearson") #lstT1-bisT2の相関
cor.test(InputData$lst_mean_T1, InputData$bas_mean_T2, method = "pearson") #lstT1-basT2の相関

#相関表6列目
cor.test(InputData$lst_mean_T2, InputData$aes_mean_T1, method = "pearson") #lstT2-aesT1の相関
cor.test(InputData$lst_mean_T2, InputData$aes_mean_T2, method = "pearson") #lstT2-aesT2の相関
cor.test(InputData$lst_mean_T2, InputData$health_mean_T1, method = "pearson") #lstT2-healthT1の相関
cor.test(InputData$lst_mean_T2, InputData$health_mean_T2, method = "pearson") #lstT2-healthT2の相関
cor.test(InputData$lst_mean_T2, InputData$positive_mean_T1, method = "pearson") #lstT2-positiveT1の相関
cor.test(InputData$lst_mean_T2, InputData$negative_mean_T1, method = "pearson") #lstT2-negativeT1の相関
cor.test(InputData$lst_mean_T2, InputData$environment_mean_T2, method = "pearson") #lstT2-envirionmentT2の相関
cor.test(InputData$lst_mean_T2, InputData$bis_mean_T2, method = "pearson") #lstT2-bisT2の相関
cor.test(InputData$lst_mean_T2, InputData$bas_mean_T2, method = "pearson") #lstT2-basT2の相関

#相関表7列目
cor.test(InputData$aes_mean_T1, InputData$aes_mean_T2, method = "pearson") #aesT1-aesT2の相関
cor.test(InputData$aes_mean_T1, InputData$health_mean_T1, method = "pearson") #aesT1-healthT1の相関
cor.test(InputData$aes_mean_T1, InputData$health_mean_T2, method = "pearson") #aesT1-healthT2の相関
cor.test(InputData$aes_mean_T1, InputData$positive_mean_T1, method = "pearson") #aesT1-positiveT1の相関
cor.test(InputData$aes_mean_T1, InputData$negative_mean_T1, method = "pearson") #aesT1-negativeT1の相関
cor.test(InputData$aes_mean_T1, InputData$environment_mean_T2, method = "pearson") #aesT1-envirionmentT2の相関
cor.test(InputData$aes_mean_T1, InputData$bis_mean_T2, method = "pearson") #aesT1-bisT2の相関
cor.test(InputData$aes_mean_T1, InputData$bas_mean_T2, method = "pearson") #aesT1-basT2の相関

#相関表8列目
cor.test(InputData$aes_mean_T2, InputData$health_mean_T1, method = "pearson") #aesT2-healthT1の相関
cor.test(InputData$aes_mean_T2, InputData$health_mean_T2, method = "pearson") #aesT2-healthT2の相関
cor.test(InputData$aes_mean_T2, InputData$positive_mean_T1, method = "pearson") #aesT2-positiveT1の相関
cor.test(InputData$aes_mean_T2, InputData$negative_mean_T1, method = "pearson") #aesT2-negativeT1の相関
cor.test(InputData$aes_mean_T2, InputData$environment_mean_T2, method = "pearson") #aesT2-envirionmentT2の相関
cor.test(InputData$aes_mean_T2, InputData$bis_mean_T2, method = "pearson") #aesT2-bisT2の相関
cor.test(InputData$aes_mean_T2, InputData$bas_mean_T2, method = "pearson") #aesT2-basT2の相関

#相関表9列目
cor.test(InputData$health_mean_T1, InputData$health_mean_T2, method = "pearson") #healthT1-healthT2の相関
cor.test(InputData$health_mean_T1, InputData$positive_mean_T1, method = "pearson") #healthT1-positiveT1の相関
cor.test(InputData$health_mean_T1, InputData$negative_mean_T1, method = "pearson") #healthT1-negativeT1の相関
cor.test(InputData$health_mean_T1, InputData$environment_mean_T2, method = "pearson") #healthT1-envirionmentT2の相関
cor.test(InputData$health_mean_T1, InputData$bis_mean_T2, method = "pearson") #healthT1-bisT2の相関
cor.test(InputData$health_mean_T1, InputData$bas_mean_T2, method = "pearson") #healthT1-basT2の相関

#相関表10列目
cor.test(InputData$health_mean_T2, InputData$positive_mean_T1, method = "pearson") #healthT2-positiveT1の相関
cor.test(InputData$health_mean_T2, InputData$negative_mean_T1, method = "pearson") #healthT2-negativeT1の相関
cor.test(InputData$health_mean_T2, InputData$environment_mean_T2, method = "pearson") #healthT2-envirionmentT2の相関
cor.test(InputData$health_mean_T2, InputData$bis_mean_T2, method = "pearson") #healthT2-bisT2の相関
cor.test(InputData$health_mean_T2, InputData$bas_mean_T2, method = "pearson") #healthT2-basT2の相関

#相関表11列目
cor.test(InputData$positive_mean_T1, InputData$negative_mean_T1, method = "pearson") #positiveT1-negativeT1の相関
cor.test(InputData$positive_mean_T1, InputData$environment_mean_T2, method = "pearson") #positiveT1-envirionmentT2の相関
cor.test(InputData$positive_mean_T1, InputData$bis_mean_T2, method = "pearson") #positiveT1-bisT2の相関
cor.test(InputData$positive_mean_T1, InputData$bas_mean_T2, method = "pearson") #positiveT1-basT2の相関

#相関表12列目
cor.test(InputData$negative_mean_T1, InputData$environment_mean_T2, method = "pearson") #negativeT1-envirionmentT2の相関
cor.test(InputData$negative_mean_T1, InputData$bis_mean_T2, method = "pearson") #negativeT1-bisT2の相関
cor.test(InputData$negative_mean_T1, InputData$bas_mean_T2, method = "pearson") #negativeT1-basT2の相関

#相関表13列目
cor.test(InputData$environment_mean_T2, InputData$bis_mean_T2, method = "pearson") #environmentT2-bisT2の相関
cor.test(InputData$environment_mean_T2, InputData$bas_mean_T2, method = "pearson") #environmentT2-basT2の相関

#相関表14列目
cor.test(InputData$bis_mean_T2, InputData$bas_mean_T2, method = "pearson") #bisT2-basT2の相関
```

##2-6. 相関係数の可視化（散布図）
```{r corplot, include = TRUE}
library(GGally)

cordata <- InputData %>% #散布図用のデータセットcordata作成
  select(child_gender_T1, eoe_mean_T1:bas_mean_T2) %>% #性別とeoeからbasまでの列を抽出
  select(-na.rm) #na.rmという謎変数が含まれていたので除外
names(cordata) #変数名確認

# png("figure/corplot.png", width = 1200, height = 1200) #図の保存先指定
cor_plot <- ggpairs(cordata, mapping = aes(colour = factor(child_gender_T1), alpha=0.5)) #性別で色分けで作図
# dev.off() #保存
print(cor_plot) #出力
```

##2-7. 欠損値分析
  * なぜかLittle's MCAR関数がエラーでうごかないので、MANOVAで全2時点参加者と1時点だけ参加者の検定を行う。
```{r missingdata_analysis, include = TRUE}
# 欠損値分析に使う変数を抽出
x <- InputData %>% 
  select_("eoe_mean_T1", "lst_mean_T1", "aes_mean_T1", "health_mean_T1", "positive_mean_T1", "negative_mean_T1", "eoe_mean_T2")

#全時点参加者と1時点目だけ参加者のカテゴリ化変数を作成
x <- x %>% mutate(particitation = if_else(eoe_mean_T2 >=1, "1", "0")) #全時点参加者を0に置換する（2時点目の変数に回答しているということは全時点参加者なので）

#ここでT1だけの参加者を1にカテゴリ化
x <- x %>% select_("eoe_mean_T1", "lst_mean_T1", "aes_mean_T1", "health_mean_T1", "positive_mean_T1", "negative_mean_T1", "particitation")
x$particitation[is.na(x$particitation)] <- 0 #particitation列のNAを0に置換
names(x) #変数名確認
x$particitation #念のため列が1,0で置換されたか確認
x$particitation <- as.factor(x$particitation) #factor型に変換
class(x$particitation)
head(x)

#particitationを独立変数としてMANOVA
result <- manova(cbind(eoe_mean_T1,lst_mean_T1,aes_mean_T1, health_mean_T1,positive_mean_T1, negative_mean_T1) ~ particitation, data = x)
summary(result) #出力
#結果メモ：従属変数間にparticipationの効果は見られなかった。
```

#（3）因子分析
```{r factoranalysis, include = TRUE}
library(lavaan)
library(semPlot)
library(semTools)
```

##3-1. HSCSの（縦断的）確認的因子分析
手順としては、(1)因子不変性の比較と最適なモデルの選択、(2)最適なモデルの適合度や因子負荷量や信頼性係数の算出

###3-1-1. long型にデータ変換
```{r handling_for_fa, include = TRUE}
#縦断的な測定不変性を検討するため、因子分析に用いるデータを【tidydata】型にする。
InputData_tidy <- InputData %>% 
  gather(key = "time", value = "hsc1", hsc1_T1, hsc1_T2) %>% 
  gather(key = "jikan1", value = "hsc2", hsc2_T1, hsc2_T2) %>% 
  gather(key = "jikan2", value = "hsc3", hsc3_T1, hsc3_T2) %>% 
  gather(key = "jikan3", value = "hsc4", hsc4_T1, hsc4_T2) %>% 
  gather(key = "jikan4", value = "hsc5", hsc5_T1, hsc5_T2) %>% 
  gather(key = "jikan5", value = "hsc6", hsc6_T1, hsc6_T2) %>% 
  gather(key = "jikan7", value = "hsc8", hsc8_T1, hsc8_T2) %>% 
  gather(key = "jikan8", value = "hsc9", hsc9_T1, hsc9_T2) %>% 
  gather(key = "jikan9", value = "hsc10", hsc10_T1, hsc10_T2) %>% 
  gather(key = "jikan10", value = "hsc11", hsc11_T1, hsc11_T2) %>% 
  gather(key = "jikan11", value = "hsc12", hsc12_T1, hsc12_T2)

InputData_tidy$time <- sub("hsc1_T", "", InputData_tidy$time) #time列のデータから"hsc_T1"文字を削除
InputData_tidy <- InputData_tidy %>% select(-starts_with("jikan")) #jikan列を削除
InputData_tidy$time <- as.numeric(InputData_tidy$time) #整数型に変換

names(InputData_tidy) #列名も確認
```

###3-1-2. モデル記述
```{r hscs_model, include = TRUE}
model <-'
EOE =~ hsc4 + hsc6 + hsc8 + hsc9 + hsc12
LST =~ hsc2 + hsc11
AES =~ hsc1 + hsc3 + hsc5 + hsc10 
'
```

###3-1-2. 配置不変から測定不変までのモデルを一気に比較してみる 
  * semToolsパッケージが必要。
  * tidydataで行数多いので推定に時間かかる。
  * 等値制約が少ないモデルと多いモデルのχ2を比較して、p値が有意（χ2値が悪化：増加）であれば等値制約が少ないほうのモデルを採用。p値が有意であれば多いほうのモデルを採用。
  * 比較結果をみると、配置不変モデルが最も適合度がよいモデルであることがわかる。
  
```{r hsc_measurement_invariance_conparison, include = TRUE}
measurementInvariance(model = model, data = InputData_tidy, std.lv = TRUE, strict = TRUE, fit.measures = c("cfi", "rmsea", "aic"), group= "time", missing = "fiml") #ものすごく推定時間かかる
```

###3-1-3. 配置不変モデルの確認的因子分析
  * 結果メモ：適合度は良好
```{r hsc_config_invariance, include = TRUE}
config <- cfa(model, data = InputData_tidy, group = "time", missing = "fiml")
summary(config, fit.measures = TRUE, standardized = TRUE) #列が長いから結構推定時間長くかかる
cfa.config.plot <- semPaths(config, "std", edge.label.cex=.8, fade = FALSE, gray = TRUE, mar=c(6,1,3,1), style="lisrel") #作図
```

##3-2. 学校環境変化尺度の探索的因子分析
分析の手順としては、（1）因子数の決定、（2）それにもとづく回転と因子負荷量の推定、（3）信頼性係数の算出、（4）再度合計得点の算出と列追加

```{r activate_packages, include = TRUE}
library(psych)
library(MASS)
library(GPArotation)
```

```{r handling_analysis_environment_fa, include = TRUE}
#因子分析用データセットの作成
library(tidyverse)
environment.data <- InputData[, 53:63] #なぜかdplyr::selectがつかえない…
names(environment.data) #変数名確認
```

###3-2-1. 平行分析（因子数の決定）
結果メモ：4因子解が推奨された
```{r parallel_anasysis, include = TRUE}
fa.parallel(environment.data, fm = "ml", fa = "fa") #fm =最尤法推定, fa=主因子法抽出
```

###3-2-2. MAPテスト（因子数の決定）
  * 結果メモ：1因子解が推奨された
```{r maptest, include = TRUE}
VSS(environment.data, n = 10) #n = 10因子までの数値を算出
```

###3-2-3. 4因子解の探索的因子分析
  * 結果メモ：項目1-2,3-4といった項目順で因子が構成されてしまっている。因子負荷は十分だが、1を超えるものもある。1因子2項目ずつでは少ないし、結果が頑健でなくなるかも。
  * 結果メモ：1因子解を採用した方がよさそう。

```{r efa_factor_four, include = TRUE}
factor4 <- fa(environment.data, nfactors = 4, rotate = "promax", fm = "ml", scores = TRUE)
print(factor4, sort = TRUE)
```
  
###3-2-4. 1因子解の因子分析（1回目）
  * 結果メモ：項目7,9,10の負荷量が0.35以下と低い。これらを削除して、再度因子分析をする。
```{r efa_factor_one, include = TRUE}
factor1 <- fa(environment.data, nfactors = 1, rotate = "none", fm = "ml", scores = TRUE)
print(factor1, sort = TRUE) #結果出力
```

###3-2-5. 1因子解の因子分析（2回目, 項目7,9,10削除）
  * 結果メモ：項目8が因子負荷0.35でまあギリギリ。これで確定とする。
```{r efa_factor_one_second, include = TRUE}
#項目7,9,10削除データ作成
environment.data.2 <- environment.data %>% select_("environment1_T2","environment2_T2", "environment3_T2", "environment4_T2", "environment5_T2", "environment6_T2", "environment8_T2", "environment11_T2")
names(environment.data.2) #変数名確認

#再度因子分析
factor1.second <- fa(environment.data.2, nfactors = 1, rotate = "none", fm = "ml", scores = TRUE)
print(factor1.second, sort = TRUE) #結果出力
```

###3-2-6. 学校環境変化尺度の信頼性係数の算出
  * 結果メモ：alpha=0.88で十分、omegatotal=0.91
```{r reliability_environment, includ = TRUE}
omega(environment.data.2,3, fm = "ml") #算出
```

###3-2-7. 学校環境尺度の最終的な合計点を再度算出し、InputDataに列追加
```{r create_subscale_environment, includ = TRUE}
InputData <- InputData %>% 
  dplyr::mutate(environment_mean_afterEFA_T2 = (environment1_T2 + environment2_T2 + environment3_T2 + environment4_T2 + environment5_T2 + environment6_T2 + environment8_T2 + environment11_T2)/8, na.rm = TRUE)
names(InputData) #合計得点追加されたか確認
```

###3-2-8. 因子分析後の学校環境変化尺度の度数分布
```{r count_environment_efa, includ = TRUE}
environment_mean_afterEFA_T2_count <- dplyr::count(InputData, environment_mean_afterEFA_T2)
knitr::kable(environment_mean_afterEFA_T2_count, digits = 2) #テーブル化
ggplot(data = InputData, mapping = aes(x = environment_mean_afterEFA_T2, fill = factor(environment_mean_afterEFA_T2))) + 
  geom_histogram(binwidth = 0.2) + 
  guides(fill = "none") #視覚化
```

###3-2-9. 因子分析後の学校環境変化尺度の基礎統計量
```{r discriptive_environment, includ = TRUE}
environment_mean_afterEFA_T2_discriptive <- 
  InputData %>% 
  select_("environment_mean_afterEFA_T2") %>%
  drop_na() %>%
  dplyr::summarise(n = n (), #グループの人数を出力
                   environment.mean = mean (environment_mean_afterEFA_T2), #environment_mean_afterEFA_T2の平均
                   environment.sd = sd (environment_mean_afterEFA_T2)) #environment_mean_afterEFA_T2のSD
environment_mean_afterEFA_T2_discriptive  #出力                 
```

###3-2-10. 確定した学校環境変化尺度と他の変数の相関
```{r corplot_environment, includ = TRUE}
cor.test(InputData$environment_mean_afterEFA_T2, InputData$hsc_mean_T1, method = "pearson") #hscT1の相関
cor.test(InputData$environment_mean_afterEFA_T2, InputData$hsc_mean_T2, method = "pearson") #hscT2の相関
cor.test(InputData$environment_mean_afterEFA_T2, InputData$eoe_mean_T1, method = "pearson") #eoeT1の相関
cor.test(InputData$environment_mean_afterEFA_T2, InputData$eoe_mean_T2, method = "pearson") #eoeT2の相関
cor.test(InputData$environment_mean_afterEFA_T2, InputData$lst_mean_T1, method = "pearson") #lstT1の相関
cor.test(InputData$environment_mean_afterEFA_T2, InputData$lst_mean_T2, method = "pearson") #lstT2の相関
cor.test(InputData$environment_mean_afterEFA_T2, InputData$aes_mean_T1, method = "pearson") #aesT1の相関
cor.test(InputData$environment_mean_afterEFA_T2, InputData$aes_mean_T2, method = "pearson") #aesT2の相関
cor.test(InputData$environment_mean_afterEFA_T2, InputData$health_mean_T1, method = "pearson") #healthT1の相関
cor.test(InputData$environment_mean_afterEFA_T2, InputData$health_mean_T2, method = "pearson") #healthT2の相関
cor.test(InputData$environment_mean_afterEFA_T2, InputData$positive_mean_T1, method = "pearson") #positiveT1の相関
cor.test(InputData$environment_mean_afterEFA_T2, InputData$negative_mean_T1, method = "pearson") #negativeT1の相関
cor.test(InputData$environment_mean_afterEFA_T2, InputData$bis_mean_T2, method = "pearson") #bisT2の相関
cor.test(InputData$environment_mean_afterEFA_T2, InputData$bas_mean_T2, method = "pearson") #basT2の相関
```

#（4）精神的健康の潜在差得点算出

##4-1. 精神的健康の潜在差得点を算出

```{r change_model, include = TRUE}
#モデル記述
lcs.health <- '
T1 =~ 1*health1_T1 + m*health2_T1 + n*health3_T1 + o*health4_T1 + p*health5_T1
T2 =~ 1*health1_T2 + m*health2_T2 + n*health3_T2 + o*health4_T2 + p*health5_T2

#誤差
health1_T1 ~~ health1_T1
health2_T1 ~~ health2_T1
health3_T1 ~~ health3_T1
health4_T1 ~~ health4_T1
health5_T1 ~~ health5_T1
health1_T2 ~~ health1_T2
health2_T2 ~~ health2_T2
health3_T2 ~~ health3_T2
health4_T2 ~~ health4_T2
health5_T2 ~~ health5_T2

#2時点間の同一項目間の誤差共分散を定義
health1_T1 ~~ health1_T2 #項目1
health2_T1 ~~ health2_T2 #項目2
health3_T1 ~~ health3_T2 #項目3
health4_T1 ~~ health4_T2 #項目4
health5_T1 ~~ health5_T2 #項目5

#free latent variances and covariances
LC ~~ var.LC*LC
T1 ~~ var.T1*T1
T1 ~~ eta*LC

#define latent difference score (fix loading to 1)
LC =~ 1*T2

#fix latent regression to 1 to define latent difference score
T2 ~ 1*T1

#fix FT2 variance to zero to define latent difference score
T2 ~~ 0*T2

#no correlations between FT2 and other latent variables 
LC + T1 ~~ 0*T2

#means
LC ~ beta*1
T1 ~ alpha*1
'

result.lcs <- lavaan(lcs.health, data = InputData, fixed.x = FALSE, missing = "fiml", meanstructure = TRUE)
summary(result.lcs, fit.measures = TRUE) #結果出力
```

```{r plot_change_model, include = TRUE}
#作図
lcs.plot <- semPaths(result.lcs, "std", edge.label.cex=.8, fade = FALSE, gray = TRUE, mar=c(6,1,3,1), style="mx")
```

##4-2. 算出された個々人の潜在得点の結果を抽出
```{r output_change_score_health, include = TRUE}
change_score <- predict(result.lcs) 
change_score <- as.data.frame(change_score) #データフレーム型に変換
health_change_score <- change_score %>% select_("LC") #差得点列だけを抽出 
head(health_change_score) #個々人の潜在得点を確認（LC列が差得点）

#潜在差得点の列をInputDataの列に追加
InputData <- bind_cols(InputData, health_change_score)
names(InputData) #列追加されたか確認
```

##4-3. 潜在差得点の基礎統計量
```{r discriptive_change_score, include = TRUE}
health_change_score_discriptive <- 
  InputData %>% 
  dplyr::summarise(n = n (), #グループの人数を出力
                   health.lcs.mean = mean (LC), #差得点の平均
                   health1.lcs.sd = sd (LC)) #差得点のSD
health_change_score_discriptive #出力（平均はモデル推定値の切片と同じになっている）
```

##4-4. 潜在差得点のヒストグラム
```{r histogram_change_score, include = TRUE}
#png("figure/healthchange_histogram.png", width = 600, height = 400)
health_change_score_histogram <- ggplot(data = InputData, mapping = aes(x = LC, colour = "black")) + 
  geom_histogram(binwidth = 0.2, colour="black") + guides(fill = "none") #視覚化
health_change_score_histogram + theme(plot.subtitle = element_text(vjust = 1), 
    plot.caption = element_text(vjust = 1), 
    axis.title = element_text(size = 16), 
    axis.text = element_text(size = 16)) +labs(x = "精神的健康の潜在差得点", y = "度数")
#dev.off()
```

##4-5. 潜在差得点のシャピロ-ウィルク検定（正規性検定）
```{r shapirotest, include = TRUE}
shapiro.test(InputData$LC)
#結果メモ：p < .05で正規分布ではないと判断。
#結果メモ：正規分布ではないという結果となった。
```

#（5）HSCSのクラスタ抽出
  * HSCSのT1とT2の下位尺度得点を用いて、クラスタリングする
  * 最適なクラスタ数を決定するためにGap統計量というものを参照するらしい（https://www.trifields.jp/how-to-decide-number-of-clusters-in-r-1677）
  * Gap統計量については、google schalarあたりでググってほしい。

##5-1. HSCのT1の下位尺度得点のみのデータセットを作成
```{r crating_hsc_dataset, include = TRUE}
#HSCのT1の下位尺度得点のみのデータセットを作成
HSC.data <- InputData %>% select_("eoe_mean_T1", "lst_mean_T1", "aes_mean_T1")
head(HSC.data) #先頭行確認
```

##5-2. Gap統計量を算出し、最適なクラスタ数を決定（参考としてk-meansも分析）
```{r determining_hsc_cluster, include = TRUE}
library(cluster)
cluster.number <- clusGap(HSC.data, kmeans, K.max = 10, B = 2000, verbose = interactive())
cluster.number #結果出力 #クラスタ数は1が適切らしい。2～7だと4が適切。
plot(cluster.number) #Gap統計量の視覚化

#4クラスタで分析
c4 <- kmeans(HSC.data, 4, algorithm = "Hartigan-Wong")
c4 #クラスタリング結果の表示
```

##5-3. HSCの潜在プロファイル分析
  * tidyLPAパッケージで実行可能。
  * 使用方法はhttps://cran.r-project.org/web/packages/tidyLPA/vignettes/Introduction_to_tidyLPA.html
  * install.packages("devtools") #ここでは開発版を使用
  * devtools::install_github("jrosen48/tidyLPA") #ここでは開発版を使用
```{r tidyLPA_package, include = TRUE}
library(tidyLPA)
```

###5-3-1. 適切なプロファイル数を検討比較
  * 結果メモ：model2とmodel3で3クラスタがもっともBICが低い。
  * 結果メモ：総合的に判断して3クラスタを採用
  * 結果メモ：モデル4と5がないのはデフォルトらしい。Mplusなら推定できるとのこと（上記URL）。
```{r determining_hsc_profile, include = TRUE}
compare_solutions(HSC.data, eoe_mean_T1, lst_mean_T1, aes_mean_T1)
```

###5-3-2. ほかのプロファイル数のBICとentropyの算出（BIC比較表作成のため）
```{r bic_hsc_profiles, include = TRUE}
#プロファイル数1
hsc.profile1 <- estimate_profiles(HSC.data,
                                 eoe_mean_T1, lst_mean_T1, aes_mean_T1,
                                 model = 3,
                                 n_profiles = 1,
                                 return_orig_df = TRUE)

#プロファイル数2
hsc.profile2 <- estimate_profiles(HSC.data,
                                  eoe_mean_T1, lst_mean_T1, aes_mean_T1,
                                  model = 3,
                                  n_profiles = 2,
                                  return_orig_df = TRUE)

#プロファイル数3
hsc.profile4 <- estimate_profiles(HSC.data,
                                  eoe_mean_T1, lst_mean_T1, aes_mean_T1,
                                  model = 3,
                                  n_profiles = 3,
                                  return_orig_df = TRUE)

#プロファイル数4
hsc.profile4 <- estimate_profiles(HSC.data,
                                  eoe_mean_T1, lst_mean_T1, aes_mean_T1,
                                  model = 3,
                                  n_profiles = 4,
                                  return_orig_df = TRUE)

#プロファイル数5
hsc.profile5 <- estimate_profiles(HSC.data,
                                  eoe_mean_T1, lst_mean_T1, aes_mean_T1,
                                  model = 3,
                                  n_profiles = 5,
                                  return_orig_df = TRUE)

#プロファイル数6
hsc.profile6 <- estimate_profiles(HSC.data,
                                  eoe_mean_T1, lst_mean_T1, aes_mean_T1,
                                  model = 3,
                                  n_profiles = 6,
                                  return_orig_df = TRUE)
```

###5-3-3. 推奨されたプロファイル数3の作図
  * 結果メモ：クラスタ1が全体の40%でHSC群に該当すると思われる。やや割合が多い？
  * 結果メモ：クラスタ2は低HSC群、クラスタ3は平均群。
```{r hsc_profile_three, include = TRUE}
hsc.profile <- estimate_profiles(HSC.data,
                                 eoe_mean_T1, lst_mean_T1, aes_mean_T1,
                                 model = 3,
                                 n_profiles = 3,
                                 return_orig_df = TRUE)

plot_profiles(hsc.profile) #作図（素点）

png("figure/hsc_profile_centered_score.png", width = 600, height = 400)
plot_profiles(hsc.profile, to_center = TRUE, to_scale = TRUE) #作図（標準化得点）
dev.off()
``` 

###5-3-4. 所属クラス列をdataの列に追加
```{r adding_hsc_profile, include = TRUE}
hsc.profile <- select_(hsc.profile, "profile")
names(hsc.profile)
InputData <- bind_cols(InputData, hsc.profile)
names(InputData) #列追加されたか確認
head(InputData) #先頭行確認
```

###5-3-5. HSCプロファイル1～3の名前変更
```{r rename_hsc_profile, include = TRUE}
InputData <- InputData %>%
  mutate(hsc.profile = recode(profile,
                            "1" = "medium",
                            "2" = "low",
                            "3" = "hsc"))
head(InputData)   
```

###5-3-6. HSCグループごとの平均値、SD
```{r discriptive_HSCS_by_profile, include = TRUE}
discriptive_HSCS_by_profile <- 
  InputData %>%
  dplyr::group_by(hsc.profile) %>% #性別でグルーピング
  dplyr::summarise(n = n (), #グループの人数を出力
                   hsc_T1_mean = mean (hsc_mean_T1), #hsc_T1の平均
                   hsc_T1_sd = sd (hsc_mean_T1), #hcs_T1のSD
                   eoe_T1_mean = mean (eoe_mean_T1), #eoe_T1の平均
                   eoe_T1_sd = sd (eoe_mean_T1), #eoe_T1のSD
                   lst_T1_mean = mean (lst_mean_T1), #lst_T1の平均
                   lst_T1_sd = sd (lst_mean_T1), #lst_T1のSD
                   aes_T1_mean = mean (aes_mean_T1), #aes_T1の平均
                   aes_T1_sd = sd (aes_mean_T1), #aes_T1のSD
                   environment_mean = mean (environment_mean_afterEFA_T2), #environment_mean_afterEFA_T2の平均
                   environment_sd = sd (environment_mean_afterEFA_T2), #environment_mean_afterEFA_T2のSD
                   health_improvement = mean (LC), #精神的健康変化の平均
                   health_sd = sd (LC)) #精神的健康変化のSD
discriptive_HSCS_by_profile
```

```{r environ_by_profile, include = TRUE}
InputData %>%
  drop_na() %>% #欠損値をデータセットから除外
  dplyr::group_by(hsc.profile) %>% #性別でグルーピング
  dplyr::summarise(n = n (), #グループの人数を出力
                   environment_mean = mean (environment_mean_afterEFA_T2), #environment_mean_afterEFA_T2の平均
                   environment_sd = sd (environment_mean_afterEFA_T2)) #environment_mean_afterEFA_T2のSD
```

#（6）環境変化→健康変化の平均単回帰（HSPプロファイルごと）

##6-1. 各HSCグループの相関係数
```{r cor_by_hsc_group, include = TRUE}

#データのグループ化

#hscのグループ
hsc.student <- InputData %>%
  filter(hsc.profile == "hsc")

#低hscのグループ
low.student <- InputData %>%
  filter(hsc.profile == "low")

#中hscのグループ
medium.student <- InputData %>%
  filter(hsc.profile == "medium")

#相関係数
cor.test(hsc.student$environment_mean_afterEFA_T2, hsc.student$LC, method = "pearson") #HSCグループ

cor.test(low.student$environment_mean_afterEFA_T2, low.student$LC, method = "pearson") #低HSCグループ

cor.test(medium.student$environment_mean_afterEFA_T2, medium.student$LC, method = "pearson") #中HSCグループ
```

##6-2. HSCグループの回帰分析
  * 結果メモ：係数 = 0.32, p < .001, R^2 = 0.11, F(1.132) = 16.37
```{r hsc_group_lm, include = TRUE}
lm.hsc <- lm(LC ~ environment_mean_afterEFA_T2, data = hsc.student)
summary(lm.hsc)
confint(lm.hsc, level = 0.95)#95%CI
```

##6-3. 低HSCグループの回帰分析
  * 結果メモ：すべて非有意
  * 結果メモ：b = 0.14, p = 0.382, R^2 = 0.02, F(1,41)=0.78
```{r lowhsc_group_lm, include = TRUE}
lm.low <- lm(LC ~ environment_mean_afterEFA_T2, data = low.student)
summary(lm.low)
confint(lm.low, level = 0.95)#95%CI
```
  
##6-4. 中HSCグループの回帰分析
  * 結果メモ：b= 0.29, p < .01, R = 0.06, F(1.165) = 10.87
```{r mediumhsc_group_lm, include = TRUE}
lm.medium <- lm(LC ~ environment_mean_afterEFA_T2, data = medium.student)
summary(lm.medium)
confint(lm.medium, level = 0.95)#95%CI
```

##6-5. 各HSCグループの散布図と回帰直線
  * 各グループの全体図（1枚目）
  * 各グループの個別図（2枚目）

###6-5-1. 各グループ全体
```{r scatterplot_hsc_group_together, include = TRUE}
#png("figure/hsc_plot1.png", width = 600, height = 400)
plot1 <- ggplot(data = InputData, aes(x = environment_mean_afterEFA_T2, y = LC, group = factor(hsc.profile), colour = factor(hsc.profile))) + 
  geom_point() +
  geom_smooth(method = "lm") +
  theme_classic(base_size = 14, base_family = "serif") +
  labs(y = "mental health improvement", colour = "profiles")
plot1 <- plot1 + labs(x = "perceived school environment change (1 = negative change, 4 = no change, 7 = positive change)") #1枚で作図
  #メモ；xラベルがなぜか変化しないので、くどいけど2行で作図。これだと変化する。
print(plot1)
#dev.off()
```

###6-5-2. 各グループ個別
```{r scatterplot_hsc_group_each, include = TRUE}
#png("figure/hsc_plot2.png", width = 800, height = 400)
plot2 <- ggplot(data = InputData, aes(x = environment_mean_afterEFA_T2, y = LC)) + 
  geom_point() +
  geom_smooth(method = "lm") +
  facet_wrap(~ hsc.profile) #並べて作図
plot2 <- plot2 + theme(plot.subtitle = element_text(vjust = 1), 
    plot.caption = element_text(vjust = 1), 
    axis.title = element_text(size = 14), 
    axis.text = element_text(size = 12), 
    axis.text.x = element_text(size = 12), 
    legend.title = element_text(size = 9)) +labs(x = "perceived school environment change (1 = negative change, 4 = no change, 7 = positive change)", 
    y = "mental health improvement") #並べて作図
print(plot2)
#dev.off()
```

#（7）HSCグループごとに分位点回帰（感度分析としての位置づけ）
```{r quantreg_package, include = TRUE}
library(quantreg)
set.seed(1234) #乱数set
```

  * リサンプリング数2000
  * wild法によるブートストラッピング

###7-1. HSCグループ
```{r hsc_quantreg, include = TRUE}
fit.hsc <- rq(LC ~ environment_mean_afterEFA_T2, data = hsc.student, tau = seq(0, 1, 0.25))
summary(fit.hsc, se = "boot", R = 2000, bsmethod= "wild")
```

###7-2. 低HSCグループ
```{r low_quantreg, include = TRUE}
fit.low <- rq(LC ~ environment_mean_afterEFA_T2, data = low.student, tau = seq(0, 1 , 0.25))
summary(fit.low, se = "boot", R = 2000, bsmethod= "wild")
```

###7-3. 中HSCグループ
```{r medium_quantreg, include = TRUE}
fit.medium <- rq(LC ~ environment_mean_afterEFA_T2, data = medium.student, tau = seq(0, 1 , 0.25))
summary(fit.medium, se = "boot", R = 2000, bsmethod= "wild")
```

#（8）階層的重回帰分析
1) 環境変数と環境×感受性の非線形効果が確認されるかをまず検討  
2) 通常の回帰分析  
ステップ1で「知覚された学校環境変化」「HSCS」、ステップ2で「知覚された学校環境変化×HSCS」を独立変数として順に投入。独立変数は全体平均値で中心化。HSCSは1時点目の得点を用いる。従属変数はwell-beingの潜在差得点。

##8-1. 中心化得点の算出
```{r centering, include = TRUE}
dat <- InputData %>% drop_na() %>% select_("hsc_mean_T1", "environment_mean_afterEFA_T2", "LC", "child_gender_T1") #na削除したうえで必要な変数抽出
hscs_c <- dat$hsc_mean_T1 - mean(dat$hsc_mean_T1) #HSCSの中心化
env_c <- dat$environment_mean_afterEFA_T2 - mean(dat$environment_mean_afterEFA_T2) #知覚された学校環境変化の中心化

wellbeing <- dat$LC #well-beingの潜在差得点の名前変更
gender <- dat$child_gender_T1 #性別T1の変数名変更
```

##8-2. 中心化できたか確認
```{r kakunin, include = TRUE}
cor(data.frame(dat$child_gender_T1, dat$hsc_mean_T1, dat$environment_mean_afterEFA_T2, dat$LC))#中心化前の変数
cor(data.frame(gender, hscs_c, env_c, wellbeing))
```

##8-3. 非線形効果の確認

###8-3-1. 階層的重回帰分析ステップ1
「知覚された学校環境変化」と「HSCS」を投入。
```{r step_one_nonlinear, include = TRUE}
reg_1 <- lm(wellbeing ~ env_c + hscs_c)
summary(reg_1)
```

###8-3-2. 階層的重回帰分析ステップ2
「知覚された学校環境変化」と「HSCS」の2乗項を追加投入。  
2次項は、I()関数を用いないと、計算できない。
```{r step_two_nonlinear, include = TRUE}
reg_2 <- lm(wellbeing ~ env_c + hscs_c + I(env_c^2) + I(hscs_c^2))
summary(reg_2)
```

###8-3-3. 階層的重回帰分析ステップ3
「知覚された学校環境変化 × HSCS」と「知覚された学校環境変化*2 × HSCS」を追加投入。
```{r step_three_nonlinear, include = TRUE}
reg_3 <- lm(wellbeing ~ env_c + hscs_c + I(env_c^2) + I(hscs_c^2) + env_c:hscs_c + I(env_c^2):hscs_c)
summary(reg_3)
```

##8-4. 通常の階層的重回帰分析
上記（8-3）の分析結果から、どうやら非線形効果はないことが確認されたので、通常の階層的重回帰分析を用いて、差次感受性を検討する。

###8-4-1. 階層的重回帰分析ステップ1
「知覚された学校環境変化」と「HSCS」を追加投入。結果メモ：モデルは有意。学校環境が正の効果。
```{r step_two, include = TRUE}
reg1 <- lm(wellbeing ~ env_c + hscs_c)
summary(reg1)
```

###8-4-2. 階層的重回帰分析ステップ2
「知覚された学校環境変化」と「HSCS」の交互作用項を追加投入。結果メモ：モデルは非有意。交互作用項も非有意。  
  * Belsky & Widaman (2018)のEditorialでは、F比が1以上であれば、交互作用の検討を行うことが推奨されている。そのため、以下では単純傾斜検定を行う。
```{r step_three, include = TRUE}
reg2 <- lm(wellbeing ~ env_c + hscs_c + env_c:hscs_c)
summary(reg2)
anova(reg1, reg2) #R^2の増加量の検定
```

##8-5. 単純傾斜検定
交互作用項は有意ではなかったが、一応単純傾斜検定してみる  

###8-5-1. HSCSの+1SDと-1SD変数の作成
```{r highlow, include = TRUE}
hscs_h <- dat$hsc_mean_T1 - (mean(dat$hsc_mean_T1, na.rm = TRUE) + sd(dat$hsc_mean_T1, na.rm = TRUE)) #HSCS +1SD
hscs_l <- dat$hsc_mean_T1 - (mean(dat$hsc_mean_T1, na.rm = TRUE) - sd(dat$hsc_mean_T1, na.rm = TRUE)) #HSCS -1SD
```

###8-5-2. +1SD推定
結果の出力は、env_cをみる。結果メモ：env_cは有意。後述の-1SDより効果高いようにみえる。
```{r high, include = TRUE}
result_h <- lm(wellbeing ~ gender + env_c + hscs_h + env_c:hscs_h)
summary(result_h)
```

###8-5-3. -1SD推定
結果の出力は、env_cをみる。結果メモ：env_cは有意。効果は+1SDより小さめ。
```{r low, include = TRUE}
result_l <- lm(wellbeing ~ gender + env_c + hscs_l + env_c:hscs_l)
summary(result_l)
```

##8-6. pequodパッケージで階層的重回帰分析（検算）
参考資料としてhttps://www.slideshare.net/makotohirakawa3/mra-42251907
```{r pequod, include = TRUE}
library(pequod)
model <- lmres(LC ~ environment_mean_afterEFA_T2 + hsc_mean_T1 + environment_mean_afterEFA_T2:hsc_mean_T1, centered = c("environment_mean_afterEFA_T2", "hsc_mean_T1"), data = dat) #交互作用の検討
summary(model)
```

##8-7. pequodパッケージで単純傾斜検定と作図（検算）
```{r simpless, include = TRUE}
model_ss <- simpleSlope(model, pred ="environment_mean_afterEFA_T2", mod1 = "hsc_mean_T1")
summary(model_ss)
PlotSlope(model_ss) #作図
```

##8-8. Roisman et al.(2012)の提案に基づき、RoS on Xテストを行う
Region of Interest(RoS) on Xについての詳細は論文を参照。
分析はRoismanらのアプリケーションを用いる：https://www.yourpersonality.net/interaction/ros.pl
アプリでの分析に必要なパラメタ（傾きパラメタ間の共分散行列）をRで算出（以下）。  
Rでの出力方法はPreacherのサイト参照：http://www.quantpsy.org/interact/acov.htm  
```{r ros, include = TRUE}
#出力のe-4というような数字は-4乗を意味している
hccm(reg2, type = "hc0") #アプリの説明によれば、共分散の情報は、Heteroscedasticity-Corrected Covariance Matricesに含まれるとのこと。
```

必要なパラメタ  
  * Intercept (b0) = 0.42592 →切片  
  * Variable X (b1) = 0.25908 →環境変数（独立変数）の回帰係数  
  * Variable Z (b2) = 0.12419 →感受性変数（調整変数）の回帰係数  
  * Interaction XZ (b3) = 0.09021 →交互作用項の回帰係数  
  * Variance parameter b1 = 0.05862^2 = 0.003 →たぶんstand.errorの2乗のことだと思う  
  * Variance parameter b2 = 0.06596^2 = 0.004 →たぶんstand.errorの2乗のことだと思う  
  * Variance parameter b3 = 0.07769^2 = 0.006 →たぶんstand.errorの2乗のことだと思う   
  * Covariance parameters b1 b3 = -0.0007060342  
  * Covariance parameters b2 b3 = -0.0017199447  
  * Degress of freedom (df) = 291 →アプリの説明によればN - 独立変数の数k - 1で計算される（この場合、295 - 3 - 1 = 291）  

  * 回帰係数の分散についてはこのサイトhttp://lbm.ab.a.u-tokyo.ac.jp/~omori/kokusai/kokusai08_1218.html　によると、回帰係数の分散の平方根が標準誤差なので、それを2乗すれば分散の値となる。

![RoS on X testing](C:\Users\Iimura Shuhei\Documents\hsc_transition\figure\RoStest.png)

  * ピンクに塗りつぶされたエリアが、Propotion of Interaction(PoI)。  
  * PoIは、素因ストレスエリアで0.04、差次感受性エリアで0.96 。  
  * cross over pointは知覚された学校環境が-1.333の位置
  * 以上の結果を踏まえると、高校移行にともなう発達は、素因ストレスではないが、差次感受性というよりもヴァンテージ感受性のようにもみえる。  


#END